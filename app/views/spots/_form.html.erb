<%# app/views/spots/_form.html.erb %>

<% api_key_value = Rails.application.credentials.dig(:google_maps, :api_key) || ENV['GOOGLE_MAPS_API_KEY'] || ENV['Maps_API_KEY'] %>

<%= form_with model: [trip, spot],
  data: { 
    turbo: false,
    controller: "geocoding", 
    'geocoding-api-key-value': api_key_value 
  }, 
  class: "space-y-8" do |f| %>
  
  <%= render 'shared/error_messages', resource: spot %>

  <%# --- 1. 日程選択 --- %>
  <div class="space-y-2">
    <%= f.label :day_number, "何日目の予定？", class: "block text-sm font-bold text-gray-700 ml-1" %>
    <div class="relative w-32">
      <%= f.number_field :day_number, min: 1, required: true, class: "w-full px-4 py-3.5 rounded-xl border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all text-center font-bold text-lg" %>
      <div class="absolute inset-y-0 right-4 flex items-center pointer-events-none">
        <span class="text-sm text-gray-500 font-bold">日目</span>
      </div>
    </div>
  </div>

  <%# --- 2. スポット名 --- %>
  <div class="space-y-2">
    <%= f.label :name, "スポット名 (必須)", class: "block text-sm font-bold text-gray-700 ml-1" %>
    <%= f.text_field :name, 
        required: true, 
        placeholder: "例: 旭山動物園", 
        class: "w-full px-4 py-3.5 rounded-xl border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all placeholder-gray-400",
        data: { 'geocoding-target': 'address', action: 'keydown->geocoding#geocodeDebounced' } 
    %>
    <%= f.hidden_field :latitude, data: { 'geocoding-target': 'latitude' } %>
    <%= f.hidden_field :longitude, data: { 'geocoding-target': 'longitude' } %>
  </div>

  <%# --- 3. 概算費用 & 滞在時間 --- %>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    
    <%# 概算費用 %>
    <div class="space-y-2">
      <%= f.label :estimated_cost, "概算費用 (円)", class: "block text-sm font-bold text-gray-700 ml-1" %>
      <div class="flex items-center gap-3">
        <span class="text-xl font-bold text-gray-400">¥</span>
        <div class="flex-1">
          <%= f.number_field :estimated_cost, min: 0, placeholder: "1000", class: "w-full px-4 py-3.5 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" %>
        </div>
      </div>
    </div>

    <%# 滞在時間（時間・分） %>
    <div class="space-y-2">
      <%= f.label :duration, "滞在時間", class: "block text-sm font-bold text-gray-700 ml-1" %>
      <div class="flex items-center gap-4">
        <%# 時間入力 %>
        <div class="flex-1 relative">
          <div class="flex items-center gap-2">
            <%= f.number_field :duration_hours, min: 0, placeholder: "1", class: "w-full px-4 py-3.5 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all text-center" %>
            <span class="text-sm font-bold text-gray-500 whitespace-nowrap">時間</span>
          </div>
        </div>
        <%# 分入力 %>
        <div class="flex-1 relative">
          <div class="flex items-center gap-2">
            <%= f.number_field :duration_minutes, min: 0, max: 59, placeholder: "30", class: "w-full px-4 py-3.5 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all text-center" %>
            <span class="text-sm font-bold text-gray-500 whitespace-nowrap">分</span>
          </div>
        </div>
      </div>
    </div>

  </div>

  <%# --- 4. 予約・参考情報 --- %>
  <div class="space-y-4 pt-4 border-t border-gray-100">
    <div class="flex items-center">
      <%= f.check_box :reservation_required, class: "h-5 w-5 text-purple-600 focus:ring-purple-500 border-gray-300 rounded cursor-pointer" %>
      <%= f.label :reservation_required, "宿泊施設（ホテル・旅館）ですか？", class: "ml-3 block text-sm font-bold text-gray-700 cursor-pointer" %>
    </div>

    <div class="space-y-2">
      <%= f.label :booking_url, "予約 / 参考URL", class: "block text-sm font-bold text-gray-700 ml-1" %>
      <%= f.url_field :booking_url, placeholder: "https://travel.rakuten.co.jp/...", class: "w-full px-4 py-3.5 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 transition-all text-sm placeholder-gray-400" %>
    </div>
  </div>

  <%# --- 5. アクションボタン --- %>
  <div class="pt-6">
    <%= f.submit btn_text, class: "w-full py-4 px-6 rounded-full text-white font-bold bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 shadow-lg transform active:scale-95 transition-all cursor-pointer text-lg" %>
    
    <div class="mt-4 text-center">
      <%= link_to "キャンセルして戻る", trip_path(trip), data: { turbo: false }, class: "text-sm font-bold text-gray-400 hover:text-gray-600 transition underline decoration-gray-300" %>
    </div>
  </div>
<% end %>